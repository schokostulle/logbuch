// ===========================================================
// dashboard.js ‚Äì Supabase-Integration
// Version: 2.1 ‚Äì 03.11.2025
// Beschreibung:
// - Vollst√§ndige Anbindung an Supabase (keine LocalStorage-Nutzung)
// - Admins d√ºrfen posten und l√∂schen
// - Normale Member k√∂nnen nur lesen
// ===========================================================

import { Logbuch } from "./logbuch.js";

document.addEventListener("DOMContentLoaded", async () => {
  const dashboardLogs = document.getElementById("dashboardLogs");
  const postSection = document.getElementById("adminPostSection");
  const postForm = document.getElementById("postForm");
  const postTitle = document.getElementById("postTitle");
  const postMessage = document.getElementById("postMessage");

  // üîê Supabase-Client pr√ºfen
  if (!window.supabase) {
    console.error("‚ùå Supabase ist nicht initialisiert! (logbuch.js fehlt?)");
    alert("Fehler: Keine Verbindung zur Datenbank.");
    return;
  }

  // üîê Aktuellen Benutzer pr√ºfen
  const { data: sessionData, error: sessionError } = await window.supabase.auth.getUser();
  if (sessionError || !sessionData?.user) {
    alert("Keine g√ºltige Sitzung ‚Äì bitte erneut anmelden.");
    window.location.href = "login.html";
    return;
  }

  const authUser = sessionData.user;

  // üîé Benutzerrolle ermitteln
  const { data: currentUser, error: userError } = await window.supabase
    .from("users")
    .select("id, username, role, status")
    .eq("id", authUser.id)
    .single();

  if (userError || !currentUser) {
    alert("Benutzer konnte nicht geladen werden.");
    window.location.href = "login.html";
    return;
  }

  if (currentUser.status !== "aktiv") {
    alert("Zugang verweigert ‚Äì Benutzer ist nicht aktiv.");
    window.location.href = "login.html";
    return;
  }

  const isAdmin = currentUser.role.toLowerCase() === "admin";

  // üìã Eintr√§ge laden
  await renderEntries();

  // Nur Admins d√ºrfen posten
  if (isAdmin) {
    postSection.style.display = "block";

    postForm.addEventListener("submit", async (e) => {
      e.preventDefault();

      const title = postTitle.value.trim();
      const message = postMessage.value.trim();

      if (!title || !message) return alert("Titel und Nachricht erforderlich.");

      const { error } = await window.supabase.from("dashboard_entries").insert([
        {
          user_id: currentUser.id,
          title,
          message,
        },
      ]);

      if (error) {
        console.error("Fehler beim Speichern:", error);
        alert("Fehler beim Erstellen des Eintrags.");
        return;
      }

      postTitle.value = "";
      postMessage.value = "";
      await renderEntries();
    });
  } else {
    postSection.style.display = "none";
  }

  // =========================================================
  // Eintr√§ge laden & anzeigen
  // =========================================================
  async function renderEntries() {
    dashboardLogs.innerHTML = "<p><em>Lade Eintr√§ge ‚Ä¶</em></p>";

    const { data: entries, error } = await window.supabase
      .from("dashboard_entries")
      .select("id, user_id, title, message, created_at, deleted")
      .eq("deleted", false)
      .order("created_at", { ascending: false });

    if (error) {
      console.error("Fehler beim Laden:", error);
      dashboardLogs.innerHTML = "<p><em>Fehler beim Laden der Eintr√§ge.</em></p>";
      return;
    }

    if (!entries || entries.length === 0) {
      dashboardLogs.innerHTML = "<p><em>Noch keine Eintr√§ge im Logbuch.</em></p>";
      return;
    }

    dashboardLogs.innerHTML = "";

    // Benutzer-Namen f√ºr Zuordnung laden
    const { data: allUsers } = await window.supabase.from("users").select("id, username");

    entries.forEach((entry) => {
      const entryDiv = document.createElement("div");
      entryDiv.classList.add("log-entry");

      const titleEl = document.createElement("h3");
      titleEl.classList.add("log-title");
      titleEl.textContent = entry.title;

      const messageEl = document.createElement("p");
      messageEl.classList.add("log-message");
      messageEl.textContent = entry.message;

      const author = allUsers.find((u) => u.id === entry.user_id)?.username || "Unbekannt";
      const date = new Date(entry.created_at).toLocaleString("de-DE");

      const footerEl = document.createElement("div");
      footerEl.classList.add("log-footer");
      footerEl.textContent = `${date} ‚Äì ${author}`;

      // üóëÔ∏è Nur Admins d√ºrfen l√∂schen
      if (isAdmin) {
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "üóëÔ∏è L√∂schen";
        deleteBtn.classList.add("delete-btn");
        deleteBtn.addEventListener("click", () => deleteEntry(entry.id));
        footerEl.appendChild(deleteBtn);
      }

      entryDiv.appendChild(titleEl);
      entryDiv.appendChild(messageEl);
      entryDiv.appendChild(footerEl);
      dashboardLogs.appendChild(entryDiv);
    });
  }

  // =========================================================
  // Soft Delete f√ºr Eintr√§ge (Admins)
  // =========================================================
  async function deleteEntry(id) {
    if (!confirm("Eintrag wirklich l√∂schen, Kapit√§n?")) return;

    const { error } = await window.supabase
      .from("dashboard_entries")
      .update({ deleted: true })
      .eq("id", id);

    if (error) {
      console.error("Fehler beim L√∂schen:", error);
      alert("Fehler beim L√∂schen des Eintrags.");
      return;
    }

    await renderEntries();
  }

  Logbuch.log("Dashboard v2.1 ‚Äì Supabase aktiv, Soft-Delete & Admin-Posting aktiv ‚öì");
});