// =============================================================
// login.js ‚Äì Supabase-only Login (v2.2)
// -------------------------------------------------------------
// - nutzt Fake-E-Mail <username>@bullfrog.fake
// - sorgt f√ºr automatisches User-Mapping in "users"-Tabelle
// - pr√ºft Benutzerstatus ('aktiv')
// - zeigt Statusmeldungen im UI statt via alert()
// =============================================================

import { supabase } from "./logbuch.js";

document.addEventListener("DOMContentLoaded", () => {
  const form = document.getElementById("loginForm");
  const nameInput = document.getElementById("loginName");
  const passInput = document.getElementById("loginPass");
  const statusBox = document.getElementById("statusMessage");

  if (!form) {
    console.warn("‚ùó login.js: loginForm nicht gefunden");
    return;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    const username = nameInput.value.trim();
    const password = passInput.value.trim();
    if (!username || !password) {
      showStatus("Bitte Name und Passwort eingeben.", "warn");
      return;
    }

    const email = `${username}@bullfrog.fake`.toLowerCase();
    showStatus("‚è≥ Anmeldung wird √ºberpr√ºft...", "info");

    try {
      // --------------------------------------------------------
      // Anmeldung bei Supabase Auth
      // --------------------------------------------------------
      const { data: signData, error: signError } = await supabase.auth.signInWithPassword({
        email,
        password,
      });

      if (signError) {
        console.error("‚ùå Login fehlgeschlagen:", signError);
        showStatus("Anmeldung fehlgeschlagen. Benutzername oder Passwort falsch.", "error");
        return;
      }

      const authUser = signData?.user;
      if (!authUser) {
        showStatus("Anmeldung fehlgeschlagen. Kein Benutzerobjekt empfangen.", "error");
        return;
      }

      // --------------------------------------------------------
      // Benutzer aus Tabelle 'users' lesen
      // --------------------------------------------------------
      const { data: userEntry, error: userError } = await supabase
        .from("users")
        .select("id, username, role, status")
        .eq("id", authUser.id)
        .maybeSingle();

      if (userError && userError.code !== "PGRST116") {
        console.error("Fehler beim Laden des Benutzer-Eintrags:", userError);
        showStatus("Fehler beim Laden des Benutzers. Bitte sp√§ter erneut versuchen.", "error");
        return;
      }

      let userData = userEntry;

      // --------------------------------------------------------
      // Wenn Benutzer nicht existiert ‚Üí neu anlegen
      // --------------------------------------------------------
      if (!userData) {
        const { data: newUser, error: insertErr } = await supabase
          .from("users")
          .insert({
            id: authUser.id,
            username,
            role: "member",
            status: "aktiv",
          })
          .select()
          .single();

        if (insertErr) {
          console.error("Fehler beim Anlegen des Benutzers:", insertErr);
          showStatus("Fehler beim Anlegen des Benutzers. Bitte Admin kontaktieren.", "error");
          await supabase.auth.signOut();
          return;
        }
        userData = newUser;
      }

      // --------------------------------------------------------
      // Zugriff nur f√ºr aktive Benutzer
      // --------------------------------------------------------
      if ((userData.status || "").toLowerCase() !== "aktiv") {
        showStatus("üö´ Benutzer ist nicht aktiv. Bitte Admin kontaktieren.", "error");
        await supabase.auth.signOut();
        return;
      }

      // --------------------------------------------------------
      // Erfolg ‚Üí Dashboard
      // --------------------------------------------------------
      showStatus(`‚úÖ Willkommen zur√ºck, ${userData.username || username}!`, "success");
      setTimeout(() => (window.location.href = "dashboard.html"), 1200);

    } catch (err) {
      console.error("‚ùå Unbekannter Fehler beim Login:", err);
      showStatus("Unbekannter Fehler beim Login. Bitte Konsole pr√ºfen.", "error");
    }
  });

  // ------------------------------------------------------------
  // Hilfsfunktion: Statusanzeige im DOM
  // ------------------------------------------------------------
  function showStatus(msg, type = "info") {
    if (!statusBox) return alert(msg);
    statusBox.innerHTML = `<p class="${type}">${msg}</p>`;
  }
});